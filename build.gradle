plugins {
    id 'java'
    id 'jacoco'
    id("org.sonarqube") version "6.0.1.5171"
    id 'com.avast.gradle.docker-compose' version '0.14.3'
}

sourceCompatibility = JavaVersion.VERSION_21

group 'com.tom'
version '1.0-SNAPSHOT'

repositories {
    mavenCentral()
}

dependencies {
    testImplementation group: 'junit', name: 'junit', version: '4.13.2'
}

sonarqube {
    properties {
//        property 'sonar.host.url', '<sonarqube_url>'
//        property 'sonar.token', '<sonarqube_dev_global_analysis_token>'
        property 'sonar.branch.name', gitBranch()
    }
}

String gitBranch() {
    String branch = ""
    Process proc = "git rev-parse --abbrev-ref HEAD".execute()
    proc.in.eachLine { line -> branch = line }
    proc.err.eachLine { line -> println line }
    proc.waitFor()
    return branch
}

jacocoTestReport {
    reports {
        xml.required = true
    }
}
test.finalizedBy jacocoTestReport
tasks.named('sonarqube').configure {
    dependsOn test
}